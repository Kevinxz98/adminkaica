<div class="wizard-container">
  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="step-indicators">
      <div *ngFor="let step of [1,2,3,4,5,6,7,8]" [class.active]="step === currentStep"
        [class.completed]="step < currentStep" class="step-indicator" (click)="goToStep(step)">
        <span class="step-number">{{step}}</span>
      </div>
    </div>

    <div class="progress-bar-vertical">
      <div class="progress-vertical" [style.height]="((currentStep - 1) / (totalSteps - 1)) * 100 + '%'"></div>
    </div>
  </div>

  <!-- Step Content -->
  <form class="col-xl-10 col-md-10 col-sm-12" [formGroup]="wizardForm" (ngSubmit)="onSubmit()">
    <!-- STEP 1: Informaci√≥n General -->
    <div *ngIf="currentStep === 1" class="step-content">
      <h2>Informaci√≥n General - {{agentName}}</h2>
      <hr>
      <div class="form-group">
        <label>¬øC√≥mo quieres llamar tu chatbot?</label>
        <input type="text" formControlName="nombre" class="form-control" placeholder="Nombre del asistente" />
      </div>

      <div class="form-group">
        <label>¬øEn qu√© categor√≠a encaja mejor tu negocio?</label>
        <select formControlName="categoria" class="form-control">
          <option value="">Selecciona una categor√≠a</option>
          <option *ngFor="let cat of categorias" [value]="cat">{{cat}}</option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øEn qu√© idioma va a responder tu chatbot?</label>
        <select formControlName="idioma" class="form-control">
          <option value="es">Espa√±ol</option>
          <option value="en">Ingl√©s</option>
          <option value="fr">Franc√©s</option>
          <option value="de">Alem√°n</option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øQuieres subir un avatar o logo para tu bot? (Opcional)</label>
        <file-pond #myPond [options]="singlepondOptions" class="single-fileupload"
          [files]="companyLogo ? [{ source: companyLogo, options: { type: 'local' }}] : []" (oninit)="pondHandleInit()"
          (onaddfile)="pondHandleAddFile($event)" (onactivatefile)="pondHandleActivateFile($event)">
        </file-pond>
        <small>Consejo: No uses tu logo de avatar</small>
      </div>
    </div>
    <!-- STEP 3: Informacion de la empresa -->
    <div *ngIf="currentStep === 2" class="step-content">
      <h2>Informaci√≥n de la empresa</h2>
      <hr>
      <div class="form-group">
        <label>Nombre de la empresa:</label>
        <input type="text" formControlName="nombreEmpresa" class="form-control" placeholder="Nombre de la empresa" />
      </div>

      <div class="form-group">
        <label>Sitio web de la empresa:</label>
        <input type="text" formControlName="sitioWeb" class="form-control" placeholder="https://www.ejemplo.com" />
      </div>

      <div class="form-group">
        <label>Descripci√≥n breve de la empresa:</label>
        <textarea formControlName="descripcionEmpresa" class="form-control" rows="3"
          placeholder="Describe brevemente tu empresa"></textarea>
      </div>
      <div class="form-group">
        <label>Horario de atenci√≥n al cliente:</label>
        <input type="text" formControlName="horarioAtencion" class="form-control" placeholder="Lun-Vie 9:00-18:00" />
      </div>
      <div class="form-group">
        <label>Informaci√≥n adicional relevante:</label>
        <textarea formControlName="informacionAdicional" class="form-control" rows="3"
          placeholder="Cualquier otra informaci√≥n que el bot deba conocer"></textarea>
      </div>
    </div>

    <!-- STEP 2: Tono y Personalidad -->
    <div *ngIf="currentStep === 3" class="step-content">
      <h2>Tono y Personalidad</h2>
      <hr>
      <div class="form-group">
        <label>¬øQu√© estilo prefieres?</label>
        <select formControlName="estilo" class="form-control">
          <option value="">Selecciona un estilo</option>
          <option *ngFor="let estilo of estilos" [value]="estilo">
            {{estilo}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øQu√© tan t√©cnico debe ser el chatbot?
          ({{wizardForm.get('nivelTecnico')?.value}}%)</label>
        <input type="range" formControlName="nivelTecnico" min="0" max="100" class="form-range" />
        <div class="slider-labels">
          <span>0% = cero tecnicismos</span>
          <span>100% = s√∫per t√©cnico</span>
        </div>
      </div>

      <div class="form-group">
        <label>¬øQuieres que el chatbot use emojis?</label>
        <select formControlName="usoEmojis" class="form-control">
          <option value="">Selecciona una opci√≥n</option>
          <option *ngFor="let opcion of usoEmojisOptions" [value]="opcion">
            {{opcion}}
          </option>
        </select>
      </div>
    </div>

    <!-- STEP 3: Mensajes Autom√°ticos -->
    <div *ngIf="currentStep === 4" class="step-content">
      <h2>Mensajes Autom√°ticos</h2>
      <hr>
      <div class="form-group">
        <label class="d-inline-block">Mensaje de bienvenida: </label>
        <button class="btn btn-sm btn-warning mx-2" type="button" (click)="generateWelcomeMessage()">
          <i class="bi bi-stars"></i> Generar Ejemplo
        </button>
        <textarea formControlName="mensajeBienvenida" class="form-control" rows="2"
          placeholder="¬øQu√© quieres que el bot diga cuando alguien inicia una conversaci√≥n?"></textarea>
      </div>

      <div class="form-group">
        <label>Mensaje cuando no est√°s disponible:</label>
        <textarea formControlName="mensajeNoDisponible" class="form-control" rows="2"
          placeholder="¬øQu√© debe responder el bot si alguien escribe fuera de horario?"></textarea>
      </div>

      <div class="form-group">
        <label>Mensaje por ausencia temporal:</label>
        <textarea formControlName="mensajeAusencia" class="form-control" rows="2"
          placeholder="Si no puedes responder por un momento, ¬øqu√© debe decir?"></textarea>
      </div>

      <div class="form-group">
        <label>Respuestas r√°pidas (opcional):</label>
        <div formArrayName="respuestasRapidas">
          <div *ngFor="let respuesta of respuestasRapidas.controls; let i = index" class="respuesta-rapida">
            <input [formControlName]="i" class="form-control" placeholder="Ej: Horarios, Tarifas, etc." />
            <button type="button" (click)="removeRespuestaRapida(i)" class="btn-remove">
              √ó
            </button>
          </div>
        </div>
        <button type="button" (click)="addRespuestaRapida()" class="btn-add">
          + Agregar respuesta r√°pida
        </button>
      </div>
    </div>

    <!-- STEP 4: Canales de comunicaci√≥n -->
    <div *ngIf="currentStep === 5" class="step-content">
      <h2>Configurar Visual</h2>
      <p>Recuerda que estas configuraciones las puedes editar cuando desees</p>
      <hr>
      <div class="form-group">
        <label>Color del widget del chatbot:</label>
        <input type="color" value="#2196F3" formControlName="color" class="form-control form-control-color" />
      </div>
      <div class="form-group">
        <label>Posici√≥n del widget en la pantalla:</label>
        <select formControlName="posicion" class="form-control">
          <option value="bottom-right">Abajo a la derecha</option>
          <option value="bottom-left">Abajo a la izquierda</option>
        </select>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="mostrarAvatar" />
          Mostrar avatar del bot en el widget
        </label>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="sonidoNotificacion" />
          Habilitar sonido de notificaci√≥n para nuevos mensajes
        </label>
      </div>
      <div class="form-group">
        <label>Tama√±o del widget del chatbot:</label>
        <select formControlName="tamanoWidget" class="form-control">
          <option value="peque√±o">Peque√±o</option>
          <option value="mediano">Mediano</option>
          <option value="grande">Grande</option>
        </select>
      </div>

      <div *ngIf="canalesArray.value.includes('WhatsApp Business')" class="form-group">
        <label>¬øCu√°l es tu n√∫mero de WhatsApp Business para conectar la API?</label>
        <input type="text" formControlName="whatsappBusiness" class="form-control" placeholder="+34 123 456 789" />
      </div>
    </div>

    <!-- STEP 5: Inteligencia / Configuraci√≥n Smart -->
    <div *ngIf="currentStep === 6" class="step-content">
      <h2>Inteligencia / Configuraci√≥n Smart</h2>

      <div class="form-group">
        <label>¬øCu√°l es el objetivo principal de tu chatbot?</label>
        <select formControlName="objetivoPrincipal" class="form-control">
          <option value="">Selecciona un objetivo</option>
          <option *ngFor="let objetivo of objetivos" [value]="objetivo">
            {{objetivo}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øQu√© preguntas reciben m√°s frecuentemente tus clientes?</label>
        <textarea formControlName="preguntasFrecuentes" class="form-control" rows="4"
          placeholder="Lista las preguntas m√°s comunes separadas por comas"></textarea>
      </div>

      <div class="form-group">
        <label>¬øHay temas que NO quieres que el bot responda?</label>
        <textarea formControlName="temasExcluidos" class="form-control" rows="4"
          placeholder="Temas sensibles o informaci√≥n confidencial"></textarea>
      </div>

      <div class="form-group">
        <label>¬øQuieres que el bot capture datos?</label>
        <div class="checkboxes-group">
          <div *ngFor="let dato of datosCapturarOptions" class="checkbox-item">
            <label>
              <input type="checkbox" [value]="dato" (change)="onDatoCapturarChange(dato, $event.target.checked)" />
              {{dato}}
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 6: Vista previa del chatbot -->
    <!-- STEP 7: Vista previa detallada del chatbot -->
    <div *ngIf="currentStep === 7" class="step-content p-0">
      <hr>
      <h2 class="text-center">Vista Previa del Chatbot</h2>
      <hr>
      <div class="preview-wrapper p-0">
        <!-- Preview principal del chatbot -->
        <div class="chatbot-preview-container p-0">


          <div class="website-simulator mt-0">

            <div class="website-header">
              <div class="website-navbar">
                <div class="website-logo">üåê {{wizardForm.get('nombreEmpresa')?.value || 'Mi Empresa'}}</div>
              </div>
              <div class="website-hero">
                <h1>Bienvenido a {{wizardForm.get('nombreEmpresa')?.value || 'nuestra empresa'}}</h1>
                <p>{{wizardForm.get('descripcionEmpresa')?.value || 'Descripci√≥n de la empresa'}}</p>
              </div>
            </div>

            <!-- Widget del Chatbot -->
            <div class="chatbot-widget" [style.background]="wizardForm.get('color')?.value || '#2196F3'">
              <!-- Cabecera del chat -->
              <div class="chat-header">
                <div class="chat-avatar">
                  <div class="avatar-circle" [style.background]="wizardForm.get('color')?.value || '#2196F3'">
                    <span *ngIf="!wizardForm.get('avatar')?.value">{{wizardForm.get('nombre')?.value?.charAt(0) ||
                      'B'}}</span>
                    <img *ngIf="wizardForm.get('avatar')?.value" [src]="getAvatarUrl()" alt="Avatar">
                  </div>
                  <div class="chat-info">
                    <h4>{{wizardForm.get('nombre')?.value || 'Mi Chatbot'}}</h4>
                    <span class="chat-status">‚óè En l√≠nea</span>
                  </div>
                </div>
                <button (click)="closeChat()" class="chat-close">√ó</button>
              </div>

              <!-- Cuerpo del chat -->
              <div class="chat-body">
                <!-- Mensaje de bienvenida -->
                <div class="message-bot">
                  <div class="message-content">
                    <p>{{wizardForm.get('mensajeBienvenida')?.value || '¬°Hola! ¬øEn qu√© puedo ayudarte?'}}</p>
                    <span class="message-time">Ahora</span>
                  </div>
                </div>

                <!-- Ejemplo de conversaci√≥n -->
                <div class="message-user">
                  <div class="message-content" [style.background]=" wizardForm.get('color')?.value || '#2196F3'">
                    <p>¬øCu√°les son sus horarios de atenci√≥n?</p>
                    <span class="message-time">Hace 1 min</span>
                  </div>
                </div>

                <div class="message-bot">
                  <div class="message-content">
                    <p>{{wizardForm.get('horarioAtencion')?.value || 'Lunes a Viernes de 9:00 a 18:00'}}</p>
                    <span class="message-time">Hace 1 min</span>
                  </div>
                </div>

                <!-- Respuestas r√°pidas -->
                <div class="quick-replies">
                  <div class="quick-reply"
                    *ngFor="let respuesta of respuestasRapidas.controls; let i = index; trackBy: trackByIndex">
                    {{respuesta.value || 'Respuesta r√°pida ' + (i+1)}}
                  </div>
                </div>
              </div>

              <!-- Input para mensajes -->
              <div class="chat-input">
                <input type="text" placeholder="Escribe tu mensaje aqu√≠..." value="¬øQu√© productos tienen?">
                <button class="send-button">‚û§</button>
              </div>
            </div>

            <!-- Posici√≥n del widget -->
            <div class="widget-position-indicator"
              [class]="'position-' + (wizardForm.get('posicion')?.value || 'bottom-right')">
              <div class="widget-bubble" [style.background]="wizardForm.get('color')?.value || '#2196F3'">
                <div class="widget-icon" (click)="openChat()">
                  <ng-container>
                    <img *ngIf="avatarUrl && wizardForm.get('mostrarAvatar')?.value" [src]="avatarUrl" alt="Avatar"
                      class="avatar-preview" />
                  </ng-container>

                  <ng-container *ngIf="!avatarUrl && wizardForm.get('mostrarAvatar')?.value">
                    ü§ñ
                  </ng-container>
                  <ng-container *ngIf="!wizardForm.get('mostrarAvatar')?.value">
                    üí¨
                  </ng-container>
                </div>
                <span class="widget-notification" *ngIf="wizardForm.get('sonidoNotificacion')?.value">1</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel de configuraci√≥n -->
        <div class="configuration-panel">
          <h3>Configuraci√≥n Aplicada</h3>

          <div class="config-sections">
            <!-- Identidad -->
            <div class="config-section">
              <h4>Identidad</h4>
              <div class="config-item">
                <strong>Nombre del chatbot:</strong>
                <span>{{wizardForm.get('nombre')?.value || 'No definido'}}</span>
              </div>
              <div class="config-item">
                <strong>Empresa:</strong>
                <span>{{wizardForm.get('nombreEmpresa')?.value || 'No definido'}}</span>
              </div>
              <div class="config-item">
                <strong>Idioma:</strong>
                <span>{{getIdiomaNombre(wizardForm.get('idioma')?.value)}}</span>
              </div>
            </div>

            <!-- Apariencia -->
            <div class="config-section">
              <h4>Apariencia</h4>
              <div class="config-item">
                <strong>Color principal:</strong>
                <span class="color-preview" [style.background]="wizardForm.get('color')?.value || '#2196F3'"></span>
                <span>{{getColorNombre(wizardForm.get('color')?.value)}}</span>
              </div>
              <div class="config-item">
                <strong>Posici√≥n:</strong>
                <span>{{getPosicionNombre(wizardForm.get('posicion')?.value)}}</span>
              </div>
              <div class="config-item">
                <strong>Avatar visible:</strong>
                <span>{{wizardForm.get('mostrarAvatar')?.value ? 'S√≠' : 'No'}}</span>
              </div>
              <div class="config-item">
                <strong>Sonido de notificaci√≥n:</strong>
                <span>{{wizardForm.get('sonidoNotificacion')?.value ? 'Activado' :
                  'Desactivado'}}</span>
              </div>
            </div>

            <!-- Comportamiento -->
            <div class="config-section">
              <h4>Comportamiento</h4>
              <div class="config-item">
                <strong>Estilo de comunicaci√≥n:</strong>
                <span>{{wizardForm.get('estilo')?.value || 'No definido'}}</span>
              </div>
              <div class="config-item">
                <strong>Nivel t√©cnico:</strong>
                <div class="tech-level">
                  <div class="tech-bar" [style.width]="wizardForm.get('nivelTecnico')?.value + '%'"></div>
                </div>
                <span>{{wizardForm.get('nivelTecnico')?.value || 50}}%</span>
              </div>
              <div class="config-item">
                <strong>Uso de emojis:</strong>
                <span>{{wizardForm.get('usoEmojis')?.value || 'No definido'}}</span>
              </div>
            </div>

            <!-- Mensajes -->
            <div class="config-section">
              <h4>Mensajes</h4>
              <div class="message-preview">
                <p><strong>Bienvenida:</strong> "{{wizardForm.get('mensajeBienvenida')?.value || 'No definido'}}"</p>
                <p><strong>No disponible:</strong> "{{wizardForm.get('mensajeNoDisponible')?.value || 'No definido'}}"
                </p>
                <p><strong>Ausencia:</strong> "{{wizardForm.get('mensajeAusencia')?.value || 'No definido'}}"</p>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="preview-actions">
            <button type="button" (click)="goToStep(1)" class="btn-edit">
              Editar Configuraci√≥n
            </button>
            <button type="button" (click)="probarChatbotDemo()" class="btn-test">
              Probar Demo Interactiva
            </button>
            <button type="button" (click)="descargarConfiguracion()" class="btn-download">
              Descargar Configuraci√≥n
            </button>
          </div>

          <!-- Nota final -->
          <div class="preview-note">
            <p>‚úÖ Tu chatbot est√° listo para implementar. Revisa que todo est√© correcto antes de continuar.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 7: Confirmaci√≥n y Activaci√≥n -->
    <div *ngIf="currentStep === 8" class="step-content">
      <h2>Confirmaci√≥n y Activaci√≥n</h2>

      <div class="form-group">
        <label>¬øDeseas guardar y activar tu chatbot ahora?</label>
        <select formControlName="estadoActivacion" class="form-control">
          <option value="">Selecciona una opci√≥n</option>
          <option *ngFor="let estado of estadosActivacion" [value]="estado">
            {{estado}}
          </option>
        </select>
      </div>

      <div class="action-buttons">
        <button type="button" class="btn-test">Probar bot</button>
        <button type="submit" class="btn-submit" [disabled]="!wizardForm.valid">
          Finalizar Configuraci√≥n
        </button>
      </div>

    </div>

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <button type="button" (click)="prevStep()" [disabled]="currentStep === 1" class="btn-prev">
        Anterior
      </button>

      <button *ngIf="currentStep < totalSteps" type="button" (click)="nextStep()" [disabled]="!isStepValid(currentStep)"
        class="btn-next">
        Siguiente
      </button>
    </div>
  </form>
</div>